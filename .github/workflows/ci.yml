name: CI/CD for Task Files

on:
  push:
    paths:
      - '**/devops_*.php'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2.12'

      - name: Validate PHP syntax
        run: |
          echo "Validating PHP syntax"
          find . -name 'devops_*.php' -exec php -l {} \;

      - name: Run tests
        run: |
          echo "Running tests"
          if [ -d "tests" ]; then
            ./tests/run-tests.sh
          else
            echo "No tests directory found, skipping tests."
          fi

      - name: Verify SSH connection
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        run: |
          echo "Verifying SSH connection"
          mkdir -p $HOME/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" | base64 --decode > $HOME/.ssh/id_rsa
          chmod 600 $HOME/.ssh/id_rsa
          ssh-keyscan -H 127.0.0.1 >> $HOME/.ssh/known_hosts
          ssh -i $HOME/.ssh/id_rsa -o StrictHostKeyChecking=no user@127.0.0.1 "echo 'SSH connection successful'"

      - name: Deploy to Local Server
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        run: |
          echo "Deploying to local server"
          ssh -i $HOME/.ssh/id_rsa -o StrictHostKeyChecking=no user@127.0.0.1 "cd /path/to/your/project && git pull origin main"
